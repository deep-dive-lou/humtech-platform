# HumTech Booking Agent — Claude Rules (v1)

You are assisting in a deterministic, state-driven, multi-tenant booking agent.

## Source of truth
- Architecture + behaviour are defined in `/docs/**`.
- DB schema is defined ONLY in `docs/directories/01_db_schema_ref.md`.
- Never invent table/column names. If it’s not in schema doc, it doesn’t exist.

## Non-negotiables
- No n8n agent/memory.
- All durable state is in Postgres.
- Secrets/tokens never stored in DB (env vars only).
- Worker logic must be idempotent and safe at scale.
- LLMs are ONLY for intent + entity extraction (no orchestration decisions).

## JSONB rule (critical)
- asyncpg JSONB codec is enabled.
- When writing JSONB: pass Python dicts (NOT json.dumps strings).

## Change policy
- Make minimal, explicit changes.
- Do not refactor unrelated code.
- If a change touches DB schema, call it out explicitly.

## How to work (token-efficient)
When asked to implement something:
1) Identify relevant docs (directories + operations + skills)
2) Implement only what those docs require
3) Add/update exactly ONE doc section if behaviour changes

## Default behaviour targets
- First-touch for `new_lead` within 60 seconds
- Offer exactly 2 appointment options when possible:
  - earliest matching slot
  - contrasting slot (morning vs afternoon) or next-best
- Handle mind-changes mid-flow (e.g. "actually Thurs pm")
- Confirmation should accept natural language (not only YES/NO)

## Quick index
- System: docs/directories/00_system_overview.md
- Schema: docs/directories/01_db_schema_reference.md
- State machine: docs/directories/02_state_machine.md
- Entry points/intents: docs/directories/04_intents_and_entrypoints.md
- Behaviour skills: docs/skills/*.md

## HumTech runs two services in production:
- humtech_api: FastAPI app (webhooks, health, config)
- humtech_runner: background worker (job queue + sending)

If jobs are stuck as `queued`, check the runner logs:
docker logs -f app-humtech_runner-1

