<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ req.client_name }} — HumTech Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">

  <!-- Header -->
  <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
    <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/portal/staff/requests" class="text-sm text-gray-400 hover:text-gray-900">← Requests</a>
        <span class="text-gray-200">|</span>
        <h1 class="text-lg font-semibold">{{ req.client_name }}</h1>
        {% set s = req.status %}
        {% if s == "draft" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">Draft</span>
        {% elif s == "sent" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Sent</span>
        {% elif s == "viewed" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">Viewed</span>
        {% elif s == "in_progress" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">In progress</span>
        {% elif s == "completed" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">Completed</span>
        {% else %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">{{ s }}</span>
        {% endif %}
      </div>
      <div class="flex items-center gap-4">
        <button
          id="copyLinkBtn"
          onclick="generateLink()"
          class="text-sm font-medium bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors"
        >
          Copy link
        </button>
        <a href="/portal/staff/logout" class="text-sm text-gray-500 hover:text-gray-900">Sign out</a>
      </div>
    </div>
  </div>

  <!-- Draft notice -->
  {% if req.status == 'draft' %}
  <div class="bg-amber-50 border-b border-amber-100">
    <div class="max-w-5xl mx-auto px-6 py-2.5 flex items-center gap-2 text-sm text-amber-700">
      <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      This request is a draft — the client has not been sent a link yet. Use <strong class="font-semibold">Copy link</strong> to get a shareable link for the client.
    </div>
  </div>
  {% endif %}

  <!-- Magic link modal -->
  <div id="linkModal" class="hidden fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl border border-gray-200 shadow-xl p-6 max-w-lg w-full mx-4">
      <h2 class="font-semibold mb-3">Magic link generated</h2>
      <p class="text-sm text-gray-500 mb-3">Send this link to the client. It expires in 30 days.</p>
      <div class="flex items-center gap-2">
        <input
          id="linkValue"
          type="text"
          readonly
          class="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-sm bg-gray-50 font-mono"
        />
        <button
          onclick="copyLink()"
          class="text-sm font-medium border border-gray-300 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
        >
          Copy
        </button>
      </div>
      <div class="mt-4 flex justify-end">
        <button onclick="closeModal()" class="text-sm text-gray-500 hover:text-gray-900">Close</button>
      </div>
    </div>
  </div>

  <div class="max-w-5xl mx-auto px-6 py-8 space-y-8">

    <!-- Client info -->
    <div class="bg-white rounded-xl border border-gray-200 p-5">
      <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Client</h2>
      <dl class="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
        <div><dt class="text-gray-400">Name</dt><dd class="font-medium">{{ req.client_name or "—" }}</dd></div>
        <div><dt class="text-gray-400">Email</dt><dd>{{ req.client_email or "—" }}</dd></div>
        <div><dt class="text-gray-400">Phone</dt><dd>{{ req.client_phone or "—" }}</dd></div>
        <div><dt class="text-gray-400">Due date</dt><dd>{% if req.due_at %}{{ req.due_at.strftime("%d %b %Y") }}{% else %}—{% endif %}</dd></div>
        <div><dt class="text-gray-400">Last viewed</dt><dd>{% if req.last_viewed_at %}{{ req.last_viewed_at.strftime("%d %b %Y %H:%M") }} UTC{% else %}Not yet viewed{% endif %}</dd></div>
        <div><dt class="text-gray-400">Sent</dt><dd>{% if req.sent_at %}{{ req.sent_at.strftime("%d %b %Y") }}{% else %}Not sent{% endif %}</dd></div>
      </dl>
    </div>

    <!-- Items -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-100">
        <h2 class="text-sm font-semibold">Document checklist</h2>
      </div>
      {% if not items %}
      <p class="px-5 py-6 text-sm text-gray-400">No items in this request.</p>
      {% else %}
      <div class="divide-y divide-gray-100">
        {% for item in items %}
        <div class="px-5 py-4" id="item-{{ item.id }}">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <p class="font-medium text-sm">{{ item.title }}</p>
                {% if item.required %}
                  <span class="text-xs text-gray-400">required</span>
                {% endif %}
                <!-- status badge -->
                <span id="status-{{ item.id }}"
                  class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                  {% if item.status == 'approved' %}bg-green-100 text-green-700
                  {% elif item.status == 'uploaded' %}bg-blue-100 text-blue-700
                  {% elif item.status == 'needs_review' %}bg-yellow-100 text-yellow-700
                  {% elif item.status == 'missing' %}bg-red-50 text-red-500
                  {% else %}bg-gray-100 text-gray-500{% endif %}"
                >{{ item.status }}</span>
              </div>
              {% if item.instructions %}
              <p class="text-xs text-gray-400 mt-1">{{ item.instructions }}</p>
              {% endif %}

              <!-- Uploaded files for this item -->
              {% set item_files = files_by_item.get(item.id | string, []) %}
              {% if item_files %}
              <div class="mt-2 space-y-1">
                {% for f in item_files %}
                <div class="flex items-center gap-2 text-xs text-gray-500">
                  <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <a href="{{ f.download_url }}" target="_blank" class="hover:underline hover:text-gray-900">
                    {{ f.original_filename }}
                  </a>
                  {% if f.size_bytes %}
                  <span class="text-gray-300">·</span>
                  <span>{{ (f.size_bytes / 1024) | round(1) }} KB</span>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Review actions -->
            {% if item.status in ['uploaded', 'needs_review'] %}
            <div class="flex items-center gap-2 flex-shrink-0">
              <button
                onclick="reviewItem('{{ item.id }}', 'approve')"
                class="text-xs font-medium px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
              >
                Approve
              </button>
              <button
                onclick="reviewItem('{{ item.id }}', 'reject')"
                class="text-xs font-medium px-3 py-1.5 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors"
              >
                Reject
              </button>
            </div>
            {% elif item.status == 'approved' %}
            <div class="flex-shrink-0">
              <button
                onclick="reviewItem('{{ item.id }}', 'reject')"
                class="text-xs text-gray-400 hover:text-gray-600 transition-colors"
              >
                Undo
              </button>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

  </div>

  <script>
    const requestId = "{{ req.id }}";

    async function generateLink() {
      const btn = document.getElementById('copyLinkBtn');
      btn.textContent = 'Generating…';
      btn.disabled = true;
      try {
        const res = await fetch(`/portal/staff/requests/${requestId}/link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        const data = await res.json();
        if (!res.ok) { alert(data.error || 'Failed to generate link'); return; }
        document.getElementById('linkValue').value = data.link;
        document.getElementById('linkModal').classList.remove('hidden');
      } finally {
        btn.textContent = 'Copy link';
        btn.disabled = false;
      }
    }

    function copyLink() {
      const input = document.getElementById('linkValue');
      navigator.clipboard.writeText(input.value);
    }

    function closeModal() {
      document.getElementById('linkModal').classList.add('hidden');
    }

    async function reviewItem(itemId, action) {
      const res = await fetch(`/portal/staff/items/${itemId}/review`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action }),
      });
      const data = await res.json();
      if (!res.ok) { alert(data.error || 'Action failed'); return; }

      // Update status badge in place
      const badge = document.getElementById(`status-${itemId}`);
      const s = data.status;
      badge.textContent = s;
      badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ' + (
        s === 'approved' ? 'bg-green-100 text-green-700' :
        s === 'uploaded' ? 'bg-blue-100 text-blue-700' :
        s === 'missing'  ? 'bg-red-50 text-red-500' :
        'bg-gray-100 text-gray-500'
      );

      // Reload the row's action buttons by refreshing the page
      window.location.reload();
    }
  </script>
</body>
</html>
