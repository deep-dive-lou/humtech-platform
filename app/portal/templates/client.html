<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if req %}Document Request{% else %}HumTech Portal{% endif %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">

  <!-- Header -->
  {% set brand_color = brand.brand_color if brand and brand.brand_color else '#111111' %}
  <div class="bg-white border-b border-gray-200">
    <div class="max-w-2xl mx-auto px-6 py-5">
      {% if brand and brand.logo_url %}
      <img src="{{ brand.logo_url }}" alt="{{ brand.brand_name or 'Portal' }}" class="h-8 object-contain mb-1">
      {% else %}
      <p class="text-xs font-semibold tracking-widest text-gray-400 uppercase">{{ brand.brand_name if brand and brand.brand_name else 'HumTech' }}</p>
      {% endif %}
      <h1 class="text-xl font-semibold mt-1">Document Request</h1>
    </div>
  </div>

  <div class="max-w-2xl mx-auto px-6 py-8">

    {% if error %}
    <!-- Error state -->
    <div class="bg-white rounded-xl border border-gray-200 p-8 text-center">
      <div class="text-3xl mb-3">ðŸ”—</div>
      <p class="font-medium text-gray-900">Link unavailable</p>
      <p class="text-sm text-gray-500 mt-2">{{ error }}</p>
    </div>

    {% else %}
    <!-- Client info bar -->
    <div class="bg-white rounded-xl border border-gray-200 p-5 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="font-medium">{{ req.client_name }}</p>
          <p class="text-sm text-gray-500">{{ req.client_email }}</p>
        </div>
        {% if req.due_at %}
        <div class="text-right">
          <p class="text-xs text-gray-400">Due by</p>
          <p class="text-sm font-medium">{{ req.due_at.strftime("%d %b %Y") }}</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Progress summary -->
    {% set total = items | length %}
    {% set done = items | selectattr("status", "in", ["uploaded", "approved"]) | list | length %}
    {% set approved = items | selectattr("status", "equalto", "approved") | list | length %}
    <div class="mb-6">
      <div class="flex items-center justify-between text-sm mb-2">
        <span class="text-gray-500">{{ done }} of {{ total }} items submitted</span>
        {% if approved == total and total > 0 %}
        <span class="text-green-600 font-medium">All approved âœ“</span>
        {% elif done == total and total > 0 %}
        <span class="text-blue-600 font-medium">All submitted â€” awaiting review</span>
        {% endif %}
      </div>
      <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
        <div
          class="h-2 rounded-full transition-all {% if approved == total and total > 0 %}bg-green-500{% else %}bg-gray-900{% endif %}"
          style="width: {% if total > 0 %}{{ (done / total * 100) | round }}{% else %}0{% endif %}%"
        ></div>
      </div>
    </div>

    <!-- Checklist -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
      <div class="divide-y divide-gray-100">
        {% for item in items %}
        <div class="p-5" id="item-{{ item.id }}">
          <div class="flex items-start gap-4">
            <!-- Status icon -->
            <div class="flex-shrink-0 mt-0.5">
              {% if item.status == 'approved' %}
              <div class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              {% elif item.status == 'uploaded' %}
              <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              {% else %}
              <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
              </div>
              {% endif %}
            </div>

            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <p class="font-medium text-sm">{{ item.title }}</p>
                {% if item.required %}
                <span class="text-xs text-gray-400">required</span>
                {% endif %}
                {% if item.status == 'approved' %}
                <span class="text-xs text-green-600 font-medium">Approved</span>
                {% elif item.status == 'uploaded' %}
                <span class="text-xs text-blue-600 font-medium">Submitted â€” awaiting review</span>
                {% endif %}
              </div>

              {% if item.instructions %}
              <p class="text-xs text-gray-400 mt-1">{{ item.instructions }}</p>
              {% endif %}

              <!-- Upload area â€” only for missing items -->
              {% if item.status == 'missing' %}
              <div class="mt-3" id="upload-{{ item.id }}">
                <label
                  for="file-{{ item.id }}"
                  class="inline-flex items-center gap-2 text-xs font-medium px-3 py-2 rounded-lg cursor-pointer transition-colors text-white"
                  style="background-color: {{ brand_color }}; opacity: 0.9;"
                  onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                  </svg>
                  <span id="label-{{ item.id }}">Choose file</span>
                </label>
                <input
                  type="file"
                  id="file-{{ item.id }}"
                  class="hidden"
                  onchange="handleFileSelect(event, '{{ item.id }}')"
                />
                <p id="progress-{{ item.id }}" class="text-xs text-gray-400 mt-1 hidden"></p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <p class="text-xs text-gray-400 text-center mt-6">
      Files are uploaded securely. Contact your advisor if you need help.
    </p>
    {% endif %}

  </div>

  <script>
    const TOKEN = "{{ token }}";

    async function handleFileSelect(event, itemId) {
      const file = event.target.files[0];
      if (!file) return;

      const label = document.getElementById(`label-${itemId}`);
      const progress = document.getElementById(`progress-${itemId}`);

      label.textContent = file.name;
      progress.textContent = 'Preparing uploadâ€¦';
      progress.classList.remove('hidden');

      try {
        // 1. Get presigned upload URL
        const urlRes = await fetch(`/portal/r/${TOKEN}/items/${itemId}/upload-url`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: file.name, content_type: file.type || 'application/octet-stream' }),
        });
        if (!urlRes.ok) { throw new Error('Could not get upload URL'); }
        const { file_id, upload_url } = await urlRes.json();

        // 2. Upload directly to Spaces
        progress.textContent = 'Uploadingâ€¦';
        const putRes = await fetch(upload_url, {
          method: 'PUT',
          headers: { 'Content-Type': file.type || 'application/octet-stream' },
          body: file,
        });
        if (!putRes.ok) { throw new Error('Upload failed'); }

        // 3. Confirm
        progress.textContent = 'Confirmingâ€¦';
        const confirmRes = await fetch(`/portal/r/${TOKEN}/files/${file_id}/confirm`, {
          method: 'POST',
        });
        if (!confirmRes.ok) { throw new Error('Could not confirm upload'); }

        // 4. Update UI
        const uploadArea = document.getElementById(`upload-${itemId}`);
        if (uploadArea) uploadArea.remove();

        const itemEl = document.getElementById(`item-${itemId}`);
        // Replace empty circle with blue check
        const icon = itemEl.querySelector('.flex-shrink-0 div');
        if (icon) {
          icon.className = 'w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center';
          icon.innerHTML = `<svg class="w-3.5 h-3.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>`;
        }
        // Add status label
        const titleRow = itemEl.querySelector('.flex.items-center.gap-2');
        if (titleRow) {
          const statusSpan = document.createElement('span');
          statusSpan.className = 'text-xs text-blue-600 font-medium';
          statusSpan.textContent = 'Submitted â€” awaiting review';
          titleRow.appendChild(statusSpan);
        }

        // Update progress bar
        updateProgressBar();

      } catch (err) {
        progress.textContent = `Error: ${err.message}. Please try again.`;
        progress.classList.add('text-red-500');
      }
    }

    function updateProgressBar() {
      const total = document.querySelectorAll('[id^="item-"]').length;
      const done = document.querySelectorAll('.bg-blue-100, .bg-green-100').length;
      const bar = document.querySelector('[style*="width:"]');
      if (bar && total > 0) {
        bar.style.width = `${Math.round(done / total * 100)}%`;
      }
    }
  </script>
</body>
</html>
